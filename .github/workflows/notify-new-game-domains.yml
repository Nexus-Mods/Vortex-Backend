name: Notify New Game Domains

# Manually triggered workflow that detects game extensions added to the manifest
# today and notifies the bot-github-vortex Slack channel about which domains need the
# "Download with Mod Manager" button enabled.

on:
  workflow_dispatch:

jobs:
  notify-new-domains:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new game extensions added today and notify Slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_SIGNING_SECRET: ${{ secrets.SLACK_SIGNING_SECRET }}
          # bot-github-vortex channel (same as constants.ts SLACK_CHANNEL)
          SLACK_CHANNEL: 'C05009EK5R6'
        run: |
          # Find the last commit before today (midnight UTC)
          TODAY=$(date -u +%Y-%m-%dT00:00:00Z)
          echo "Looking for changes since: $TODAY"

          BASE_REF=$(git log --before="$TODAY" -1 --format="%H" -- out/extensions-manifest.json)

          if [ -z "$BASE_REF" ]; then
            echo "No previous commits found for the manifest. Treating entire manifest as new."
            PREV_IDS='[]'
          else
            echo "Comparing against commit: $BASE_REF ($(git log -1 --format='%ci' "$BASE_REF"))"
            PREV_IDS=$(git show "$BASE_REF":out/extensions-manifest.json 2>/dev/null \
              | jq '[.extensions[].modId]' 2>/dev/null || echo '[]')
          fi

          # Find new game extensions added since the base commit
          NEW_GAMES=$(jq --argjson prev "$PREV_IDS" '
            [.extensions[] | select(.type == "game" and (.modId as $id | $prev | index($id) | not))]
          ' out/extensions-manifest.json)

          COUNT=$(echo "$NEW_GAMES" | jq 'length')

          if [ "$COUNT" -eq 0 ]; then
            echo "No new game extensions found today. Nothing to notify."
            exit 0
          fi

          echo "Found $COUNT new game extension(s):"
          echo "$NEW_GAMES" | jq -r '.[] | "  - \(.gameName // .name) (modId: \(.modId), gameId: \(.gameId // "N/A"))"'

          # Build the domain list for Slack (using mrkdwn format)
          DOMAIN_LIST=$(echo "$NEW_GAMES" | jq -r '.[] |
            if .gameId then
              "• *\(.gameName // .name)* — <https://www.nexusmods.com/\(.gameId)/|\(.gameId)>"
            else
              "• *\(.gameName // .name)* — _domain not available (modId: \(.modId))_"
            end
          ')

          # Build and send Slack message
          PAYLOAD=$(jq -n \
            --arg channel "$SLACK_CHANNEL" \
            --arg domains "$DOMAIN_LIST" \
            '{
              channel: $channel,
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "New Game Extension(s) Published"
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: (":joystick: Please enable the *Download with Mod Manager* button for the following game domains:\n\n" + $domains)
                  }
                }
              ]
            }')

          RESPONSE=$(curl -s -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          # Check response
          OK=$(echo "$RESPONSE" | jq -r '.ok')
          if [ "$OK" = "true" ]; then
            echo "Slack notification sent successfully to bot-app"
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "unknown error"')
            echo "::error::Failed to send Slack notification: $ERROR"
            exit 1
          fi
